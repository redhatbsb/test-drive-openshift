# 2.11 - Utilizando banco de dados

[Permalink](https://github.com/redhatbsb/test-drive-openshift/blob/8ce43c5cb511571d907947f2d78a595d00910586/parte-2-openshift-4x/utilizando-banco-de-dados-mysql.adoc)

Cannot retrieve contributors at this time

 167 lines \(110 sloc\) 6.35 KB

## Utilizando banco de dados MYSQL <a id="user-content-utilizando-banco-de-dados-mysql"></a>

### Deploy de um MySQL persistente <a id="user-content-deploy-de-um-mysql-persistente-atrav&#xE9;s-de-um-template-no-openshift-4.x"></a>

#### Selecionando o Banco do Catálogo <a id="user-content-selecionando-o-banco-do-cat&#xE1;logo"></a>

Acesse o catálogo e selecione o MySQL \(`+Add` → `From Catalog` → `Databases`→ `Mysql` → `Instantiate Template`\)

#### Customizando Informações <a id="user-content-customizando-informa&#xE7;&#xF5;es"></a>

Agora preencha as informações conforme abaixo:

Verifique o tamanho do storage e clique em `Create`

Após aguardar alguns minutos, o resultado final, será o container do mysql rodando no seu projeto:

#### Corrigindo o sistema de autenticação <a id="user-content-corrigindo-problema-autenticacao"></a>

O Mysql 8 precisa que a forma de autenticação seja alterada para que nosso codigo funcione. Assim, execute o seguinte comando no mysql depois de conectar no terminal:

```text
mysql -u root
ALTER USER 'redhat' IDENTIFIED WITH mysql_native_password BY 'redhat';
```

### Conectando a aplicação ao Banco <a id="user-content-altera&#xE7;&#xE3;o-da-aplica&#xE7;&#xE3;o-para-apontar-para-o-banco-de-dados-persistente"></a>

#### Preparando o codigo <a id="user-content-preparando-o-codigo"></a>

Vamos mostrar uma lista de cidades cadastradas no banco de dados com essa aplicação.  
 Para isso o primeiro passo será conectar a nossa aplicação já existente neste banco de dados, para isso precisamos adicionar o trecho de código abaixo ao arquivo `index.php` já existente.

```text

echo "Openshift Workshop v2.0 ";
echo $_SERVER['SERVER_ADDR'];
echo "
";
echo "Cidades cadastradas no Banco de Dados:";
$conn = new mysqli("mysql", "redhat", "redhat", "workshop");
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
$result = $conn->query("SELECT nome FROM cidade");
if ($result->num_rows > 0) {
    while($row = $result->fetch_assoc()) {
        echo "" . $row["nome"] . "";
    }
} else {
    echo "0 results";
}
$conn->close();
?>
```

Como a tabela que está sendo consultada ainda não existe você estará vendo que existem zero cidades cadastradas neste momento.

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_277.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_277.png)

### Populando o Banco <a id="user-content-popule-o-banco-de-dados-a-partir-da-sua-m&#xE1;quina-local"></a>

#### A partir da sua máquina local <a id="user-content-a-partir-da-sua-m&#xE1;quina-local"></a>

| Note |  Execute esse labs somente se instruído pelo instrutor. Se o instrutor avisar para pular essa etapa, vá para [A partir da Web Console]() |
| :--- | :--- |


Para criar a nossa tabela que a nossa aplicação está consumindo os dados, vamos utilizar o recurso de **port-forward**. Este recurso permite que uma porta TCP remota possa ser acessada como se estivesse disponível localmente através do uso de túnels.

```text
# Veja o nome do pod do mysql
oc get pods

# Execute o port forward
oc port-forward <pod id> 3306:3306
```

Caso você esteja usando um cluster somente seu \(oc cluster up\), não há necessidade de logar conforme mencionado acima. Basta executar o comando direto:

```text
oc get pods
nohup oc port-forward <pod id> 3306:3306 &
```

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_279.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_279.png)

O comando `oc port-forward` mantém o terminal preso enquanto estiver executando. Para continuar com os próximos passos, será necessário abrir um segundo terminal no nosso servidor.

Para executar os passos seguintes, é necessário instalar o mysql. Para isso, rode:

Neste momento temos o MYSQL disponível ```localmente'', podemos conectar a ele com ferramentas gráficas ou como será demonstrado aqui com o `mysql client``. Lembre-se de abrir um outro terminal ou colocar o processo do port-forward em background. Importante é que ele deve estar rodando antes de executar o comando abaixo:

```text
mysql -u redhat -h 127.0.0.1 -P 3306 --password=redhat --execute="USE workshop; CREATE TABLE cidade (id INT NOT NULL, nome VARCHAR(50) NOT NULL, PRIMARY KEY (id)); INSERT INTO cidade (id,nome) VALUES(1,'Rio de Janeiro'); INSERT INTO cidade (id,nome) VALUES(2,'Brasilia'); INSERT INTO cidade (id,nome) VALUES(3,'Recife');"
```

#### A partir da Web Console <a id="user-content-a-partir-da-console"></a>

Você pode também utilizar a console conforme demonstrado no item anterior [Corrigindo o sistema de autenticação]() e executar os seguintes comandos na console.

```text
mysql -u redhat -h 127.0.0.1 -P 3306 --password=redhat --execute="USE workshop; CREATE TABLE cidade (id INT NOT NULL, nome VARCHAR(50) NOT NULL, PRIMARY KEY (id)); INSERT INTO cidade (id,nome) VALUES(1,'Rio de Janeiro'); INSERT INTO cidade (id,nome) VALUES(2,'Brasilia'); INSERT INTO cidade (id,nome) VALUES(3,'Recife');"
```

### Acessando a aplicação <a id="user-content-acessando-a-aplica&#xE7;&#xE3;o"></a>

Ao acessar novamente a interface de nossa aplicação a mesma deverá mostrar a lista de cidades incluídas neste passo.

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_281.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_281.png)

Assim que todos os exercícios tiverem terminados, podemos parar o port-forward. Para isso, basta acessar o terminal em questão e executar um Ctrl + C.

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_164.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_164.png)

### Organizando a aplicação na Web Console <a id="user-content-organizando-a-aplica&#xE7;&#xE3;o-na-web-console"></a>

O Openshift 4 vem com algumas funções novas que permitem organizar sua aplicação para tornar-se mais intuitiva para operadores ou mesmo para outros desenvolvedores que participam do projeto. Vamos inserir o banco de dados dentro do contexto da aplicação e criar um link entre a App e o Banco para demonstrar o fluxo da informação.

#### Inserindo o DB na aplicação <a id="user-content-inserindo-o-db-na-aplica&#xE7;&#xE3;o"></a>

Para isso, basta arrastar o BD para a aplicação do Workshop conforme demonstrado abaixo:

#### Demonstrando o fluxo da comunicação <a id="user-content-demonstrando-o-fluxo-da-comunica&#xE7;&#xE3;o"></a>

Ao passar com o mouse sobre o pod da aplicação, uma seta deve aparecer. Arraste-a para o BD.

