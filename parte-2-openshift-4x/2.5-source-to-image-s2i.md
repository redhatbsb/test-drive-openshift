# 2.5 - Source to image \(s2i\)

[Permalink](https://github.com/redhatbsb/test-drive-openshift/blob/8ce43c5cb511571d907947f2d78a595d00910586/parte-2-openshift-4x/source-to-image.adoc)

Cannot retrieve contributors at this time

 251 lines \(171 sloc\) 8.05 KB

## Source to Image \(S2I\) <a id="user-content-source-to-image-s2i"></a>

### Introdução <a id="user-content-introdu&#xE7;&#xE3;o"></a>

Usaremos uma aplicação php como exemplo para demonstrar as funcionalidades do Openshift. O primeiro passo que executaremos é a criação de um repositório no github.

### Criar nova aplicação no github <a id="user-content-criar-nova-aplica&#xE7;&#xE3;o-no-github"></a>

Crie o arquivo `index.php` no GitHub com o seguinte conteúdo

```text

echo "Openshift Workshop v1.0"; (1)
echo $_SERVER['SERVER_ADDR']; (2)
?>
```

1. Escreve na tela o cabeçalho
2. Mostra o ip do servidor \(pod\)

| Note |  Essa linha com o conteudo $\_SERVER é opcional, ela mostrará na tela o IP do pod em que está sendo executada. |
| :--- | :--- |


[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_240.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_240.png)

Conteúdo do arquivo.

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_241.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_241.png)

Clique em `commit new file` para criar o arquivo.

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_242.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_242.png)

#### Usando a linha de comando <a id="user-content-usando-a-linha-de-comando"></a>

Os passos mostrados acima também podem ser feitos pela linha de comando conforme abaixo:

| Caution |  Atenção. Só execute os comandos do `git` abaixo caso você **não** tenha criado os arquivos pela web console conforme [mostrado nas imagens acima](). |
| :--- | :--- |


Faça o clone deste novo repositório e crie a página inicial `index.php`

```text
git clone https://github.com/<seu-usuario-do-github>/workshop-ocp.git && cd workshop-ocp
```

Faça o commit do código para o servidor git.

```text
git add index.php
git commit -am "first commit"
git push -u origin master
```

No final de tudo, devemos ter um arquivo `index.php` no nosso repositório do github.

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_243.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_243.png)

Agora que já temos uma aplicação, podemos prosseguir.

### Deploy utilizando S2I <a id="user-content-deploy-utilizando-s2i"></a>

#### Usando o Catalogo <a id="user-content-usando-o-catalogo"></a>

Selecione PHP

* Selecione no menu esquerdo `+Add`
* Filtre o template `PHP` no submenu `From Catalog`.
* Selecione `Create Application`
* Selecione o template `PHP` na versão `7.2`.
* Preencha o campo `Git Repo URL` com o valor [`https://github.com//workshop-ocp.git`](https://github.com/%3Cseu-usuario-do-github%3E/workshop-ocp.git)
* Preencha o campo `Name` com o valor `workshop-ocp`
* Deixe o item `Create a route to the application` marcada

| Caution |  Repare que no campo Git Repository URL você deve trocar o pelo usuário da sua conta do github. |
| :--- | :--- |


#### Acompanhando o Build <a id="user-content-acompanhando-o-build"></a>

Um novo build será executado assim que for clicado em `Create`. Para acompanhar clique no incone indicado na imagem abaixo:

O build deve estar sendo executado e a tela abaixo é o resultado

#### Acessando a Aplicacao <a id="user-content-acessando-a-aplicacao"></a>

Para acessar a aplicacao, escolha `Topology` no menu esquerdo e clique no icone da aplicacao que está sendo construída. Entao, no menu que se abre, role até o final onde deverá haver a rota criada para a aplicação. Clique na rota para acessar a aplicação.

O resultado deve ser algo similar a isso:

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_248.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_248.png)

#### Usando a linha de comando <a id="user-content-usando-a-linha-de-comando-1"></a>

Você também pode usar a linha de comando para fazer o S2I.

```text
oc new-app https://github.com/<seu-usuario-do-github>/workshop-ocp.git
```

Nesse caso, o Openshfit irá tentar adivinhar qual a linguagem que você utilizou na sua aplicação.

### Escalar os Pods <a id="user-content-escalar"></a>

A partir do menu esquerdo `Topology`, acesse os detalhes da aplicação, e em `Overview` vlique na seta para cima na lateral do círculo do pod, clique até escalar a aplicação para 2 ou mais pods.

| Tip |  Este procedimento simples mostra a facilidade para escalar uma aplicação recém-criada. |
| :--- | :--- |


### Source-to-Image utilizando o Quarkus <a id="user-content-source-to-image-utilizando-o-quarkus"></a>

Iremos agora utilizar o Source to Image com uma aplicação Java que utiliza o [Quarkus](http://quarkus.io/). Primeiro criaremos a aplicação e depois publicaremos no Openshift.

Crie um novo repositório no seu github de nome: **quarkus-app**. Para isso siga os mesmos passos descritos no guia [Criar nova aplicação no github]()

Agora crie o projeto do quarkus `getting-started` a partir do terminal através do comando maven:

```text
mvn io.quarkus:quarkus-maven-plugin:0.28.1:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=getting-started \
    -DclassName="org.acme.getting.started.GreetingResource" \
    -Dpath="/hello"
```

| Tip |  Ele irá criar uma nova pasta contendo todos os arquivos necessários para que o projeto do quarkus funcione corretamente. |
| :--- | :--- |


Acesse a pasta do projeto que foi criada:

A imagem oficial do java procura por um arquivo jar dentro da pasta target depois que o projeto for compilado no processo Source-to-Image. O Quarkus irá gerar dois arquivos JARs, o que acaba confundindo o Openshift na hora do deploy. Com o intuito de contornar isto, vamos instruir o Openshift por qual arquivo ele deve buscar. Crie uma pasta chamada `.s2i` contendo um arquivo com nome de `environment`. Execute:

```text
mkdir .s2i && touch .s2i/environment
```

O conteúdo do arquivo environment deve ser:

environment

```text
MAVEN_S2I_ARTIFACT_DIRS=target (1)
S2I_SOURCE_DEPLOYMENTS_FILTER=*-runner.jar lib (2)
JAVA_OPTIONS=-Dquarkus.http.host=0.0.0.0 (3)
AB_JOLOKIA_OFF=true (4)
```

1. Diretório que ele deve buscar o binário final \(JAR\)
2. Filtro que ele utiliza para buscar somente os JARs que contenham `-runner.jar` no nome.
3. Java Option que são passadas na hora da inicialização
4. Desabilita o Jolokia já que não utilizaremos ele agora

Como iremos utilizar o cliente git para acessar o github, configure seu email e nome/sobrenome de acordo com seu usuário no github:

```text
git config --global user.email ""
```

```text
git config --global user.name ""
```

Defina a pasta como um projeto git e adicione todos os arquivos através dos comandos:

Agora faça o commit dos arquivos:

```text
git commit -m "first commit"
```

Adicione o endereço do seu repositório que acabou de criar e faça o push:

```text
git remote add origin https://github.com/<seu_usuario>/quarkus-app.git
```

| Note |  Lembre-se de alterar o para o seu usuário do github |
| :--- | :--- |


```text
git push -u origin master
```

Agora vamos criar a aplicação no Openshift.

1. No menu esquerdo superior clique em **+Add**
2. Depois selecione **From Catalog**
3. Na busca, digite **openjdk**
4. Selecione o template **Red Hat OpenJDK 8** que executará a versão **11** do Java
5. Clique em **Create Application**

Logo em seguida, preencha os valores conforme abaixo:

Agora clique em `Create` no fim da tela.

Em poucos segundos sua aplicação já deverá estar disponível.

#### Limpeza do ambiente <a id="user-content-limpeza-do-ambiente"></a>

Para limpar nosso ambiente, execute o seguinte comando:

```text
oc delete all -l application=quarkus-app
```

