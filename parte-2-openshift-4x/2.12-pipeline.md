# 2.12 - Utilizando pipeline

[Permalink](https://github.com/redhatbsb/test-drive-openshift/blob/8ce43c5cb511571d907947f2d78a595d00910586/parte-2-openshift-4x/pipeline.adoc)

Cannot retrieve contributors at this time

 130 lines \(87 sloc\) 3.83 KB

## Pipeline <a id="user-content-pipeline"></a>

### Introdução <a id="user-content-introdu&#xE7;&#xE3;o"></a>

O Openshift possui integração nativa com o Jenkins, o que nos permite criar pipelines de forma simples.

### Criando o Jenkinsfile no GitHub <a id="user-content-criando-o-jenkinsfile-no-github"></a>

Crie um arquivo chamado `jenkins-pipeline.groovy` dentro do seu repositório do github. Para isso, siga o procedimento, já demonstrado nos labs anteriores, de criação do novo arquivo pela Web Console do Github. O conteúdo do arquivo segue abaixo:

```text
 node('maven') {
    stage('build') {
        echo 'building app :)'
    }
    stage('verify') {
        echo 'dummy verification....'
    }
    stage('deploy') {
        input 'Manual Approval'
    }
    stage('promoting to QA') {
       echo 'fake stage...'
       sleep 5
    }
}
```

No final, seu repositório deve estar conforme imagem abaixo:

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_282.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_282.png)

### Criando o BuildConfig <a id="user-content-criando-o-buildconfig"></a>

Precisamos criar um `BuildConfig.` que aponte para o `Jenkinsfile` do nosso repositório no github.

Pela Web Console, clique em `+Add` → `YAML` conforme imagem abaixo:

| Warning |  Repare que existe um campo no código abaixo que **deve ser alterado com o nome do usuário do github**. |
| :--- | :--- |


```text
kind: "BuildConfig"
apiVersion: "build.openshift.io/v1"
metadata:
  name: "workshop-pipeline"
  annotations:
    pipeline.alpha.openshift.io/uses: '[{"name": "workshop-ocp", "kind": "DeploymentConfig"}]'
spec:
  source:
    type: "Git"
    git:
      uri: "https://github.com//workshop-ocp.git" (1)
  strategy:
    type: "JenkinsPipeline"
    jenkinsPipelineStrategy:
      jenkinsfilePath: "jenkins-pipeline.groovy"
```

1. Altere o valor dessa url para estar de acordo com seu github

No Openshift, depois de ter colado o código acima, clique em `Create`

### Deploy do Jenkins <a id="user-content-deploy-do-jenkins"></a>

Vamos fazer o deploy do Jenkins no nosso projeto. Para isso, clique em `+Add` → `From Catalog` → `Jenkins (Ephemeral)`

E agora digita na busca `Jenkins` e clique em `Jenkins (Ephemeral)`

Clique agora em `Instantiate Template` e deixe os campos com seus valores defaults \(sem alterar nada\) e clique em `Create`.

Agora volte para página da Topologia clicando em `Topology` no menu lateral esquerdo. Aguarde até que o círculo do Jenkins fique azul escuro.

| Tip |  O Jenkins pode demorar até uns 8 minutos para subir. Aproveite e busque uma xícara de café. |
| :--- | :--- |


### Iniciando o pipeline <a id="user-content-iniciando-o-pipeline"></a>

Vamos iniciar nosso pipeline. Clique em `Builds` → `Workshop-pipeline`

Agora inicie o build clicando em `Actions` → `Start Build`

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/jenkins-login.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/jenkins-login.png)

Aceite as permissões

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/allow-permissions.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/allow-permissions.png)

Quando seu pipeline estiver executando, ele ficará semelhante a imagem abaixo:

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/pipeline.png)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/pipeline.png)

### Limpeza do ambiente <a id="user-content-limpeza-do-ambiente"></a>

Depois de ter finalizado o seu pipeline, limpe seu ambiente rodando o comando:

```text
oc delete all -l app=jenkins-ephemeral && oc delete bc workshop-pipeline
```

