# 2.4 - Tolerância a falhas

[Permalink](https://github.com/redhatbsb/test-drive-openshift/blob/8ce43c5cb511571d907947f2d78a595d00910586/parte-2-openshift-4x/tolerancia-a-falha.adoc)

Cannot retrieve contributors at this time

 103 lines \(60 sloc\) 3.79 KB

## Tolerância à falhas <a id="user-content-toler&#xE2;ncia-a-falhas"></a>

### Introdução <a id="user-content-introdu&#xE7;&#xE3;o"></a>

O Openshift/Kubernetes garante que a quantidade de instâncias \(Pods\) definidas para uma aplicação seja respeitada mesmo que um problema aconteça. O responsável por fazer este controle é o [`Replication Controller`](https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/) ou o [`Replica Set`](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/).

Neste laboratório vamos testar esse recurso.

### Scale up <a id="user-content-scale-up"></a>

#### Usando a Web Console <a id="user-content-usando-a-web-console"></a>

O nosso primeiro passo é fazer o `scale up` da nossa aplicação.

| Caution |  Não escale para muitos pods pois isso pode causar problemas no ambiente, já que o Openshift está rodando em ambiente compartilhado e as cotas de cada usuário estão generosas. |
| :--- | :--- |


Para isso, clique em `Topology` no menu lateral esquerdo e depois clique em cima da pod conforme imagem abaixo, depois em `Overview` e por fim clique na seta que aponta para cima para escalar para 2 instâncias.

Quando o círculo estiver azul escuro significa que o novo pod foi corretamente provisionado e já está pronto para receber novas requisições.

| Note |  Estes novos Pods são imediatamente incluídos no balanceamento de carga. Se estiver usando o browser para testar o balanceamento certifique-se de apagar o cookie pois este é utilizado para afinidade de sessão \(sticky session\). |
| :--- | :--- |


No final, sua aplicação deve estar conforme imagem abaixo:

#### Usando o CLI <a id="user-content-usando-o-cli"></a>

O mesmo que fizemos na Web Console pode também ser feito usando a linha de comando. Para escalar para 2 instâncias, execute:

```text
oc scale deploy/workshop-openshift --replicas=2
```

### Garantia do número de réplicas <a id="user-content-garantia-do-n&#xFA;mero-de-r&#xE9;plicas"></a>

#### Usando a Web Console <a id="user-content-usando-a-web-console-1"></a>

Para testar o comportamento vamos deletar um `Pod` em execução. O intuito é simular uma falha.

Clique em cima da bola da sua aplicação, depois em `Resources` e clique em um dos dois pods que são mostrados na tela.

| Tip |  Na tela a seguir, antes de apagar nosso pod, repare que temos acesso ao uso de recursos da nossa aplicação Quarkus. Vale a pena notar que a memória fica em torno de 50 Megabytes \(não de heap mas de toda memória\). Não se esqueça que é uma aplicação Java. |
| :--- | :--- |


Clique em `Actions` e depois em `Delete Pod`.

Confirme a deleção:

Volte para a tela inicial clicando em `Topology` do lado esquerdo do menu.

Quando o POD é deletado, o Openshift o recupera automaticamente como pode ser visto na imagem abaixo. Nesse exemplo, um Pod novo é criado \(cor azul claro\) e outro está sendo finalizado \(cor azul escuro\) mas sempre mantendo a quantidade de 2 instâncias rodando.

| Tip |  Este comportamento evita aquele caso clássico de precisar ligar para alguém de operações para reiniciar a aplicação em um caso de falha |
| :--- | :--- |


#### Usando o CLI <a id="user-content-usando-o-cli-1"></a>

Também podemos deletar um Pod usando a linha de comando:

```text
oc delete po <nome do pod>
```

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-pod.gif)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-pod.gif)

### Limpeza do ambiente <a id="user-content-limpeza-do-ambiente"></a>

Agora podemos apagar essa aplicação já que não a utilizaremos mais nos labs posteriores. O comando abaixo executa essa limpeza:

```text
oc delete all -l app=workshop-openshift
```

[![image](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-all.gif)](https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-all.gif)

Ao fim desse lab, sua tela do Openshift deve estar conforme imagem abaixo:

